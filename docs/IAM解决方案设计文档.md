# IAM解决方案设计文档

## 目的
提供一个开箱即用的 **IdentityServer** 解决方案，实现 **OAuth2** 和 **OpenID Connect** 认证与授权功能，以便提供 **SSO（单点登录）** 和 **API 保护**。

---

## 功能特性

### 协议支持
- 支持 **OAuth 2.0** 与 **OpenID Connect**
- 覆盖授权码、客户端凭证、设备码、刷新令牌等授权类型
- OIDC 提供 **ID Token**、用户信息端点和发现文档

### 发现与元数据公开
- 暴露 `.well-known/openid-configuration`
- 列出授权、令牌、用户信息、自检、撤销、结束会话等端点与支持能力

### 令牌服务与验证
- 颁发与验证 **Access Token**、**ID Token**
- 支持签名密钥管理
- 支持令牌自检（Introspection）与撤销（Revocation）

### 客户端与资源注册
- 管理机密/公共客户端
- 配置重定向 URI、允许的授权类型、作用域、权限策略
- 支持跨应用 SSO 会话

### 用户认证与外部身份集成
- 本地用户名/密码、多因子认证、会话管理
- 支持外部 IdP（如 Google OIDC）联邦登录与单点登录

### 权限与作用域建模
- 定义 API 作用域与资源
- 声明（Claims）映射与最小化
- 同意页与授权记录

### 安全与合规能力
- 防重放与 CSRF（state、nonce）
- 支持 **PKCE**
- 机密客户端凭证保护
- 密钥滚动、审计日志与会话注销

> **要求**：能够方便与 **ASP.NET Core** 应用程序集成，并提供相关配置。

---

## 数据结构

- **授权验证**  
  参考 **OpenIdDict** 数据结构设计，使用标准实体模型定义，便于 **EF Core** 持久化。
  
- **用户角色**  
  参考 **ASP.NET Core Identity** 数据结构设计，使用标准实体模型定义，便于 **EF Core** 持久化。

---

## 项目架构

- **定义层**：实体与 EF Core
- **业务层**：Manager 实现业务逻辑
- **服务层**：对外提供接口
- 数据结构处理与加密算法参考 **IdentityServer4** 和 **OpenIdDict** 的实现方式，以 **Helper** 或 **Service** 形式提供
- 提供与 **ASP.NET Core Identity** 的集成支持

---

## 技术选型

- 后端：`Ater.Web.Template` 模块，**.NET 10** + **ASP.NET Core**
- 数据库：**Entity Framework Core** + **Postgres**
- 标准：遵循 **OAuth2** 和 **OpenID Connect** 规范
- 前端：**Angular 20** + **Angular Material**

---

## 前端设计

### 🔐 1. 登录与认证相关页面
- **登录页**
  - 用户名/密码登录
  - 支持多因子认证（短信/邮箱/OTP）
  - 支持外部 IdP 登录（Google、企业微信）
- **注册页（可选）**
  - 用户注册、邮箱/手机号验证
- **忘记密码/重置密码页**
  - 发送重置链接或验证码
- **同意授权页（Consent Page）**
  - 展示作用域（Scopes）
  - 用户选择“同意/拒绝”

### 👥 2. 用户与组织管理
- **用户管理页**
  - 用户列表（搜索、分页）
  - 新增/编辑用户（基本信息、状态）
  - 分配角色、权限
  - 启用/禁用用户
- **角色管理页**
  - 角色列表、新增/编辑角色
  - 为角色分配权限
- **权限/资源管理页**
  - 权限点（菜单、按钮、API）
  - 新增/编辑权限
  - 权限分组（模块化管理）
- **组织/部门管理页（可选）**
  - 组织树结构
  - 用户与部门绑定
  - 部门级权限继承

### 🔑 3. 授权与客户端管理
- **客户端应用管理页**
  - 注册新客户端（ClientId、Secret、RedirectUri）
  - 配置授权模式（授权码、客户端凭证、刷新令牌等）
  - 配置作用域
- **作用域（Scope）管理页**
  - 定义系统支持的作用域（openid、profile、email、自定义 API 权限）
  - 配置作用域描述、包含的 Claims
- **授权记录页**
  - 查看用户已授权的客户端
  - 撤销授权（Revoke）

### 🛡️ 4. 安全与会话管理
- **会话管理页**
  - 查看当前活跃会话（设备、IP、登录时间）
  - 支持远程登出
- **令牌管理页**
  - 查看 Access Token / Refresh Token
  - 手动撤销 Token
- **审计日志页**
  - 登录日志（成功/失败）
  - 权限变更日志
  - 管理员操作日志

### ⚙️ 5. 系统配置与运维
- **密钥管理页**
  - 查看/轮换签名密钥（JWKs）
- **系统设置页**
  - 登录策略（密码复杂度、锁定策略）
  - Token 生命周期配置
  - SSO Cookie 策略
- **监控与健康检查页**
  - 系统运行状态
  - API 调用统计
  - 告警信息

---

## 文档要求
- 详细的表结构设计文档
- 各功能模块的设计说明
- 运行与对接指南

---

## 实施步骤
1. 定义实体模型  
2. 实现基础加密和数据处理等业务无关功能  
3. 在 Manager 层提供实体的增删改查操作  
4. 根据 OAuth2 和 OIDC 规范，实现各授权类型的处理逻辑  
5. 提供相关服务接口  
6. 实现前端界面，提供配置与管理功能  
7. 提供与 ASP.NET Core Identity 的集成支持  
8. 编写文档，说明各模块设计与实现细节  
9. 编写单元测试，确保功能正确性与稳定性  
10. 提供示例项目，展示集成与使用方式  

---

我已经将内容结构化为 Markdown，你可以直接将它放入项目文档中使用。  
如果你需要的话，我还可以帮你把这个文档的 **项目架构** 部分用 **Mermaid 流程图** 可视化出来，方便展示整体结构。  

你要我帮你画这个架构流程图吗？